#!/bin/sh

NAMESPACE=$1

# Convert the branch name into a string that can be turned into a valid URL
BRANCH_RELEASE_NAME=$(echo $CIRCLE_BRANCH | tr '[:upper:]' '[:lower:]' | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-18 | sed 's/-$//')

enable_branch() {
  echo "Creating configmap with maintenance mode enabled"
  kubectl create configmap $BRANCH_RELEASE_NAME -n $NAMESPACE --from-literal=MAINTENANCE_MODE=true --dry-run -o yaml | kubectl -n $NAMESPACE apply -f -
  kubectl rollout restart deployment -n $NAMESPACE $BRANCH_RELEASE_NAME
}

enable_main() {
  echo "Creating configmap with maintenance mode enabled"
  kubectl create configmap laa-assess-crime-forms -n $NAMESPACE --from-literal=MAINTENANCE_MODE=true --dry-run -o yaml | kubectl -n $NAMESPACE apply -f -
  echo "Restarting deployment"
  kubectl rollout restart deployment -n $NAMESPACE laa-assess-crime-forms-app
}

if [[ "$CIRCLE_BRANCH" == "main" ]]; then
  enable_branch
else
  enable_main
fi
