#!/bin/sh

NAMESPACE=$1

# Convert the branch name into a string that can be turned into a valid URL
BRANCH_RELEASE_NAME=$(echo $CIRCLE_BRANCH | tr '[:upper:]' '[:lower:]' | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-18 | sed 's/-$//')

enable_branch() {
  echo "Creating configmap with maintenance mode enabled"
  kubectl -n $NAMESPACE create configmap $BRANCH_RELEASE_NAME-settings --from-literal=MAINTENANCE_MODE=true
  echo "Restarting branch deployment"
  kubectl -n $NAMESPACE rollout restart deployment $BRANCH_RELEASE_NAME
}

enable_main() {
  echo "Creating configmap with maintenance mode enabled"
  kubectl -n $NAMESPACE create configmap laa-assess-crime-forms-settings --from-literal=MAINTENANCE_MODE=true
  echo "Restarting deployment"
  kubectl -n $NAMESPACE rollout restart deployment laa-assess-crime-forms-app
}

if [[ "$CIRCLE_BRANCH" == "main" ]]; then
  enable_branch
else
  enable_main
end
