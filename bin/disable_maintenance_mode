#!/bin/sh

NAMESPACE=$1

# Convert the branch name into a string that can be turned into a valid URL
BRANCH_RELEASE_NAME=$(echo $CIRCLE_BRANCH | tr '[:upper:]' '[:lower:]' | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-18 | sed 's/-$//')

disable_branch() {
  echo "Creating configmap with maintenance mode disabled"
  kubectl -n $NAMESPACE create configmap $BRANCH_RELEASE_NAME --from-literal=MAINTENANCE_MODE=false --dry-run -o yaml | kubectl -n $NAMESPACE apply -f -
  echo "Restarting branch deployment"
  kubectl -n $NAMESPACE rollout restart deployment $BRANCH_RELEASE_NAME
}

disable_main() {
  echo "Creating configmap with maintenance mode disabled"
  kubectl -n $NAMESPACE create configmap laa-assess-crime-forms --from-literal=MAINTENANCE_MODE=false  --dry-run -o yaml | kubectl -n $NAMESPACE apply -f -
  echo "Restarting deployment"
  kubectl -n $NAMESPACE rollout restart deployment laa-assess-crime-forms-app
}

if [[ "$CIRCLE_BRANCH" == "main" ]]; then
  disable_branch
else
  disable_main
end
